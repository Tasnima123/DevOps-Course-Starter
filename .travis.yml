language: generic
services:
- docker
- mongodb
before_install:
- docker build --target test --tag my-test-image .
install:
- wget https://releases.hashicorp.com/terraform/"$TF_VERSION"/terraform_"$TF_VERSION"_linux_amd64.zip
- unzip terraform_"$TF_VERSION"_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- rm terraform_"$TF_VERSION"_linux_amd64.zip
- terraform init
script:
- docker run --env-file .env.test my-test-image tests/int_unit
- docker run -e FLASK_APP=todo_app/app -e FLASK_ENV=development -e SECRET_KEY=secret_key -e FLASK_SKIP_DOTENV=True -e MONGO_COLLECTION=todos -e client_id -e client_secret -e disable_login=False -e redirect_uri -e MONGODB_CONNECTION_STRING=$MONGODB_CONNECTION my-test-image tests/e2e
- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- docker build --target production --tag $DOCKER_USERNAME/my-test-image:latest .
- terraform apply -var="location=uksouth" -var="client_id=$client_id" -var="client_secret=$client_secret" -auto-approve
deploy:
  provider: script
  script: bash webhook.sh
  on:
    all_branches: true
env:
  global:
  - TF_VERSION=0.14.7
  - secure: y1nfDSfF3/+vTpk32GC771VY7mcBz84DH7qDlJRzr7TtKSL0/Ya8XhBgmsu5FZ4buwSrzc3Ua3r9t8SyXXC7tCXO4S+eYlIDmq8do9XK0Np+4GNqERuNqY+fq6pDxJHf3SL3n7U/U5L97uJKAOXyCjSDOTlDOTJ9fgf8BZ7nxYCwu+4Xzc5VYN7hNde/GWeAUaiSxPBPnziNBVW+JwJqoafOjMGo1SAFxp4tl16SZLZbpSigF+iTeLF2w80ZNdqgmkiH7SY2Jv8nART7DnkifCTL68PBz95AX3sbUjCHGxU61NS7IJBMxeYbQGbjZIQFJH0c2MqfCsV1Qqc5KicVMkqAvjvIFmpuz1FVWVyfbn+QAUzX9fqvzxK0ViT8Y62Zw4kd7EQwL9VzWXlqNYUAI1uAvEqp0YZLyioFZzd5w5UrYKzf0jNau0duOm/ShN+ggbhZ/LpkogahCuQrwkFPpk4SNevkdvk8yIWZgjnGPATgxD25C2wGStH+es7jwxfrT1oQSGvPmIVkkMq7HdZ56KB/uvSJK28zwLFmYgvzZK28zlST5W0Fhhs6CDNG57GvqE0obTtDE83bLfxYw++lKnzOvgMiJboJM4YdZj9gDr4smjpoEDwOXh6po4Nu4+uLKOsf6R8A0bQtFjBrWVGN93abJV/U+SyDlcSvIVSxuAQ=
  - secure: SqWtfkrApujjHus5KaHOxfd+eI7ek6pp/BkzTy+ezkf6JKn0VrCa3+S4mf0FvdPu7rhh6jgSD4VY8n4ondGHFmWhh7vkor13kt926xkajHkvPyp7CLev4oZ0Xd9/pR1ftVOHe5/+E+GFBcldLITm0tud8/XSSWEBNHIbMbasNNwvSQLFIRUBDE5dqoPCE9YIQ7WVmMP9L0Gk2/U0wzxdIpUbItrYrc0bpbaNJioLFrW9S5FsMQ8IiKzFMj72ienm9Oj48itOkji5oZpiaHAQevcL+0trLdwDQH0O8aosMT/J/yPMXmoe+3raVfyH/qxscrLTx24JPnyYmz9DEcbABske4sA6rXCHowRK8L4qHRytkikKSNLvQFO915Z8NuVc5D1bK41Zkyt2w0Y4Wca7sCvDx3/Kpkn7zDpc2DhiALe+ABZscx5NPiu+Nu4oBxX9c9lQM6RhRKeMFw7ex0yQihDldYDZCu2aEs102roF7uNrN1NF+z/LxfhIDkqqM9G8aumKd70zklh3dAqAvjO821OMQq3RlqlJ9hB8569VvGJ98wC2GL1XMcQLQo6J2OiboIOiRX8sEaPrmQ6lp/MQ/PRtKTsYX7xJV+/BXUbFOBVQ7mDkHJfv/FMtWENvl/Q/f6OXV4B5SWMXSbVML5Dw3UsfTlhul57bMJoq+9Tx4so=
  - secure: wSyI3cByvxEsmpr2GReyF6WyXdAS4LGZONUQrhFJk8Q7+vdgtYIcaCqt57oIsOnRjb3SPvnvgY1fjgixuLqTPqcgUd7PDnuXrXn8qVv0MsVEEJOH1Fqj0Ya82Qk7dj93rhciIzRzXgSPTbfB0Qx20osmcU70OMpdsbmft30MIM7B2phCmeePFnC3ekPX1ktQ2qTTKNYk7umL430JOGrTaEqhRZ3j9F3z8cdwM50MQNx2HPiQCRF0QoSy8Vtu0+23EqF8bWeRSpWooYIAmZajE3jv9u+CCho5la636R7uK02ABcWskfYNcr3xc0Ls9lyaj6TYil4Lhb7iNLWkiwdEEZ96/yC5Kbz20+++8Qplak2VfFmDq6IpIH4WBJ2n9Vr2QJvVr2/2zsKd63mxvvtZIQyo/uDLGxUyh2ssITv9hln3KUGLrEm9yLX7oR4RMN6jyY2lXpCmZZhxTQ6PuTm3ANTmlnIJSO95T0T+rTKwgGr/2smFWAYnQ3ww7UKKLypm0RV6eLdXqEmpXdyvheQcTuNOgeiJkk17/Miv/qd0LvmdSv0Cj32e7YRjTaURjebJZy9M/zGuQJG1UFm2luF/B/oFygE6IuBck6XOaYp2uYxHAXBTWcvd6hZGDdDgZ8PtBiCNggzBNMP15PG1I1cbdcjSxX8zbba2N0dAnuvqd/I=
  - secure: SbG97+rG7PP1qe8PPMUdhgUYRW2nTh7WiVfzUk9lfvY9+/SbwYVDQ3V+QrzBPjYkcNXecPwBmLt5uHPfETIrBVxx/wVOQeLLE8wpigXuP+haHIcOaraEaeh44e3fnf6Ftno/BxrlARTJ7QVvWisc6bQb0YkzvRpUY8x6/oAeA8HSc06tknQW8nCqV965alG1FFJlxaBw1wTOunHUxLyHDcJOdZFK2eLaPoZEpybffkGjF/ru4ixhWoLWQoLDIx+ZeF7/QQ74Olvp5jHxowT/B4kNHfMHabZ78tEfQSzTL8go4cqrLznkRh24SJ+lwVxY8KVuC3GmjwMDqi9hV2ZimbL+qxU887+9CQzLH9vxPvo2Qem48mXmK/JqUH8i68OD9yyoj9a1llouC/JOc15A45eCzE2iskV0xQCL5dALeejHlM4lWtH6IAWbCiX7Ar+AY+P+dJvDkNm5rw6FKqZW1uv8RLyrzxaC1Dca/DZcK9+Dwnl7f93H2Xb6ke7J1bZgpl+F1wcR7BBds5WEOJPiWYaRo2TsnSfk6sjg7pW0Ucc/ZcGN4AdViY8MNielC1qJv5KwTtcHkKqTV/oIK5mTfA+c5O/uzUibUgOqgziU3Euamn4L2Ieujfwsg0UNrbiUpDy1GMpo7XfI6nIeuVRuvOY1n4Cp91aDk4wV/Iw+8/Y=
  - secure: HEQyQmkcN+bwqi6lNi0hlqTX+rN3bG5VPKy3zhssY1OiSHUrdbLy8qSpqGPRM8/D7psRX4r5GyFW81JS6x0eo/cEetEb7I3xGr2NbzNR16PQxI7TdWUGB2ZAOC1n8P7/NIrY59KY+X6ZjSPydHv76LAlotyL/Ihwi9qS/EXc5MRSE4jVVbMFuxuYn8hKutR0v3it1JT0pVaCAEwM2GhYD9svFEhPFjO1GYYHu8lmD+PwlX8O6kCB4HCmsbPnVxiM8W4wyLtY7zd39BG+tbI2RO12V9ZUvTW0z4VmX+WJ7wZDq6NPT0F045MfXB0/+ZIyuirAorwr9kCtJAz1c9zXfimO1Vgdjo6B2CbVXn+VXabYvPxvR/duacy4r+ep+m2AT5NAIkcf0t7DZINCKz4W3Bsta90mPALGWIrQUYBkpB7gNb15LpsTSHsQkztqfj8tIA/B/MomWmOqNbc2Ef/ovGhg8q8xDi8Y7g4Mv7M1IMTWQ1krCcyzJBl3g1THSPHLDGzJWyHAHpJGo4wBwerZCSQqVS4eC/WvFBSyv6XTvi7zfkqLhqay7exaDzOdPqdtGFnGD/TG9Uo0nuG7Fk8gSn5px3oKpfeTDxKHv0jJL25I3RJuio2UjlV6yjHVSV2klgIm9AH9rN/uiCmNv2NWWUtdNL8x8ZA8inKPpUKFZvg=
  - secure: pRPMFQcHiYEtpSD5GeDwVWW/bgw+KjSoHa7/gENziJHfy5+6qAgeBhSHVEDtbSmK6oqGv6mkhkCAoFStb0bZLInNjhby8Gz6jwBqz9IpEAJYGLT7T098gV2oJZtAoGEYn/yPWMctOYR1Wi2tXeXVpTOOa4ZOyxMxA6w4i6YhCihyoR59WPoUY040LdjsPZsX2n/ydTlUpIxHzLQxrZx70QotPING/DVyjrsS/espHLWxbiv4Bq5d+BZHuuromIpaFNxnfwfv3WuzmGMGereaW/eJt0O4UT6tNG47eVpqklk0KguAaeepkxUQBBjZWNgLkk0pkHQSdUt4AYonqxLn+n9QcCj8+LQyLj0y31/FUTxZokTMMGtLAv0hO2puHCTXvyhfIDa7l+7bsfL0Gyoeqfer0Rz3y1liwFfjIzqz++iUhvoZyTHkJtPg6hUVLG2VcmlJg/EQbWsF87DioDYxCB/7wFr8MOvkSiasqo6cQMbhrFi0wDn1NO9Pgki2esRoLB4+5D3HxGfv2pd+MrDXC0omBcpBBZ2qgU0d+a7CNV/uUN4fX4HSYLXP3EL4fpkMMgYIyHWFFVUbtdQ+3MP2ZvhScsTF7DV+4ph/hOy9+OaXsMAvfw+rxad8RY1L4SMqBxIbrywFiuvlt1XQd+HWkk5+oPlKV74mSe2LKFF0NEE=
  - secure: bNLvku8LI4Uz/WU+EqXyQGrsrY8woDXVzBcN4lPJoO/gS4WKJDD6Vm+rRkRaUEOPZWBzRJN4ta3vrPiufEXnit8VazqtCG8HYuMxq6I8uStGjUuC1x96kfi8F3HYrbasdLMIBvpbxsDWMSU5/dTomnk3fgrISujw6nv9RyruR7lxv/N9ErSzF4LCPXSvQVWn2aqadMZtY+AqWtwYLQbqY4nQHsOGhdicGZim9YfhWknD74DhQpDb3GYvE4WdAuegVw/oD7RGEmiylW4cQEd4XTg8pceNH4UQSCiL6h6z/kM/MKgOZziIoQJhgCT8Ua8Dy9yspu9A6Luvi/2QgHazUwycHAAZd+K5Z/8NQSe8K47to7ildOJOzJWEyPYnyUwgKZ6x1BVZmael/oK02oPCx1GyFa8PCB/iqoOUvAWq9SyeLaPivIsMWMXRRM1AkyBy1qAFxQ9309QHCjO3G+2anluMQYJ/7F1qTmf2aNHI0Q1IMAqgL7pms3bPq571+5Hq8FL9DQdFrRd46zJjFtFFewpPO4XNEo+wwKtqrJJn9V+dwGX6A/yxzgcqzRtODq6KhBLw2J/nTRw78avPJwMNtVbgbyjyk4SE7rSC+Kl9fwaM1kj9ltAWwtVol0RIFcVFKPDa53TElp0VOmVKGMjc9YKJtGQWFgQEvQFR0TQ8JrY=
  - secure: Vs/XfdyWHkD0yLqhR4TP2C0xdMChzdkcVo97V5wkpmRCEA1EP0lIqPIyUus6iD485kcwyZ1BZUSpq7gF9SBp6NBozPrU9qF5+OYS9mKz9/EPE5+hmOp5qZK8NFzlyx+cAbT/SKjSOMmXPr3rLETKbSXxHI9whJFPKP42rAAk68on7MjpGORGvpD7ZnZbcvf0lAySfnHdA6bNY8FTPkXO5I2/Z1o/ubpKdoVWZmlA+uyiImzaAJkVXYiNagKZrqnnCPc2bVPyeRdLiOivb1k6SBfcTalMlHeRUsoGnbZoEClWbrrfKCFg+OKAmTip3Bo12RtvEhzp+IpRx0YF1OpjFz9znDqxLez/xUBSDTVZNE739Jh5IVEbqEYvzRJ2Cu7oOrkU9LPqJOnSV1CZsExZCxKqYheThrSX8MSnJr3JCIv7rOB3E/yXNUCJD3Ru3aZQU4XFiPx0Iji5uCseK27JFimvo82TvUEuRvrlxfjfJRQfkVFvMBCukUvSzAPLdaqyL1jgAd/qPbsGqI/48GkI36sIf4oT8xXLWyETc5iJTH+RdkOQov5KE6/lza8o6puYEqrCk2i9EPRXli4V8VKmD75XphbQ/E9/2ilQa08HjYs7tsNhtUGZ57idAYb5LHzH3XBPtWwBJynoraUjhc2N0tv79ynxWI8bANN7m8ESr+g=
  - secure: Hrg0WvCNiqlCPtyU6ZdkaZvQycGVtUQ+1eTdgz3SYGtO+fpzGeqXJJ+fwOm/I2V32kxE0Ccudt2sYzF2AWdGXVA3vusujGCaeus2AJGnGoSwcIUrvz7EYOckia+iW44A3//isbsYKMrN98cjv85MW/IicNk5NezRwd0ZGuwsiB58/l2840vcqK6ZRX+K2XHxLIVnZwQZCh4cvfyWIfiAklpwGa7yvb+mPkGMUYE5PDv15J54ucmANLBifFUP40e4e4KNK/v7y5TU79FecO+2w4ikLhbqGtBuggTSe7iBH5I2Ux89V7hkfA7KnN0PRjDLhQIgxMseF+u14gSUG0A+fWlFbjSchzGMNjVkUpH6H6lvzJGenEnsEeoXtmbFPbn9HJIL4AG/YrgfmPBwPwC/EwPrd/VDLmV8V0idPmPlTntwDQmm7Fq6XvodmAPKHeuGX3MZyIQkjWWYj24AX3AOV0evJS8msoOurIoj0Oo0MeFhhkl2FlObASlqZUn1zF23Cx5ha9xi4DCSmZsLD2OvfmQDT+R3QxxRdU97aV6c7aoUMRD48ZGbm44C68a+bWszLFlN+N14G8T3pUlvgOr78LA0X8odXz17EbgMpXif0Rw5fGNLTz9Vnf2DJi1MvB4jrBRD+rpV2qrXbUhqzpOYtjHIuILDuKl3kcnbYbzvpAk=
  - secure: flX5Gf7pj+sGRzPY4AAiPSU6ZDm8n2kYjA/XiAKQs5x9YPuV/SnUfhcnPKWZ7B1kbBXekggXSJVrEye0e7Gjl3mpkU/Wzh5F4i2m1erjQFCTT1cTXMh6IOmjjvkpnB38glDyMnDBbW+rsBcVHnVwXu83nvdM8ubUdnQPg8hojpbfcpIeCiSA/X0w0jqIYyl+9+q9WuZ4BII3IcBHsqDvPu38K0GSoPjXZiOyakCfGdgeNjESLK8HW05rHWvhv+QmreQngs23/swcpcqBwXbO5mWQgVY7MNdTvHqN9qlbeC3j5mpTZNZ+ai47g5SThPgDUPigvFSrB9YSKx4aUJPBJwdoinqEBzCKGOwiX8/K9w40bRVENRLTUK32rN17X3MynUYaDLPKj5iE2sVWwcUTSAf9qRuz7F/yw90zpdjOid+6plKiNGIHaUGm9eXrk0cBUTGQYUzKER3TzdGy02gmQjfMrv7a3UFcGLFycLfpTdGSskjRwxzGeFjjC61cruwkLV10Fri1cYV8xAxkYahwPzDtpdfUUeBHAgwn6Qmlx69Jhqghuh0vvFon4+6lHxZZSdVR0nW8bglgR/CtkORrE32T/D6VpwqWK1KUFpYleciM9DTn4F6dE9Ygamw+vK18emp7JOyTCg8bh6bc3pXnryvX7WC/ZzLbAKiGeUysuCs=